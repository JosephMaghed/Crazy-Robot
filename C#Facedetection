using OpenCvSharp;
using System.Collections.Generic;
using System.Diagnostics;
using UnityEngine;
using static System.Net.Mime.MediaTypeNames;

public class FaceGestureDetector : MonoBehaviour
{
    WebCamTexture webcam;
    CascadeClassifier faceCascade;

    float baselineY = -1f;
    float baselineX = -1f;
    bool calibrated = false;
    bool neutral = true;
    float calibrationTime = 5f;
    float calibrationTimer = 0f;
    List<Vector2> calibrationSamples = new List<Vector2>();

    // Thresholds (tune for sensitivity)
    public float jumpThreshold = 40f;
    public float duckThreshold = 90f;
    public float swipeThreshold =750f;

    void Start()
    {
        // Start webcam
        webcam = new WebCamTexture(320, 240);
        GetComponent<Renderer>().material.mainTexture = webcam;
        webcam.Play();

        // Load Haar face cascade
        string cascadePath = System.IO.Path.Combine(UnityEngine.Application.streamingAssetsPath, "haarcascades/haarcascade_frontalface_default.xml");
        if (!System.IO.File.Exists(cascadePath))
            UnityEngine.Debug.LogError("Cascade file not found at: " + cascadePath);

        faceCascade = new CascadeClassifier(cascadePath);
    }

    void Update()
    {
        Mat frame = OpenCvSharp.Unity.TextureToMat(webcam);
        Mat gray = new Mat();
        Cv2.CvtColor(frame, gray, ColorConversionCodes.BGR2GRAY);

        var faces = faceCascade.DetectMultiScale(gray, 1.1, 4);

        if (faces.Length > 0)
        {
            var face = faces[0];
            Vector2 faceCenter = new Vector2(face.X + face.Width / 2, face.Y + face.Height / 2);

            // --- Calibration phase ---
            if (!calibrated)
            {
                calibrationTimer += Time.deltaTime;
                calibrationSamples.Add(faceCenter);

                int countdown = Mathf.CeilToInt(calibrationTime - calibrationTimer);
                string text = (countdown > 0) ? "Calibrating... " + countdown : "Calibrated!";
                Cv2.PutText(frame, text, new OpenCvSharp.Point(20, 40),
                            HersheyFonts.HersheySimplex, 1, Scalar.Red, 2);

                if (calibrationTimer >= calibrationTime)
                {
                    float sumX = 0f, sumY = 0f;
                    foreach (var sample in calibrationSamples)
                    {
                        sumX += sample.x;
                        sumY += sample.y;
                    }
                    baselineX = sumX / calibrationSamples.Count;
                    baselineY = sumY / calibrationSamples.Count;
                    calibrated = true;
                    UnityEngine.Debug.Log("Calibration complete. Baseline X: " + baselineX + " Y: " + baselineY);
                }
            }
            else
            {
                // --- Movement detection ---
                float deltaY = faceCenter.y - baselineY;
                float deltaX = faceCenter.x - baselineX;

                // Detect Jump
                if (deltaY < -jumpThreshold && neutral == true)
                {
                    UnityEngine.Debug.Log("Jump detected"+deltaY);
                    neutral = false;

                }

                // Detect Duck
                else if(deltaY > 90 && neutral == true)
                {
                    UnityEngine.Debug.Log("Duck detected"+deltaY);
                    neutral = false;

                }

                // Detect Swipe
                else if(deltaX > swipeThreshold && neutral == true)
                {
                    UnityEngine.Debug.Log("Swipe Right detected");
                    neutral = false;

                }
                else if(deltaX < -swipeThreshold && neutral == true)
                {
                    UnityEngine.Debug.Log("Swipe Left detected");
                    neutral = false;
                }

                else if (deltaY>-jumpThreshold&&deltaY<90&&deltaX<swipeThreshold&&deltaX>-swipeThreshold)
                {
                    neutral = true;
                }
            }

            // Draw face box & baseline
            Cv2.Rectangle(frame, face, Scalar.Green, 2);
            if (calibrated)
            {
                Cv2.Line(frame,
                    new OpenCvSharp.Point(0, baselineY),
                    new OpenCvSharp.Point(frame.Width, baselineY),
                    Scalar.Blue, 2);

                Cv2.Line(frame,
                    new OpenCvSharp.Point(baselineX, 0),
                    new OpenCvSharp.Point(baselineX, frame.Height),
                    Scalar.Blue, 2);
            }
        }

        // Show frame
        GetComponent<Renderer>().material.mainTexture = OpenCvSharp.Unity.MatToTexture(frame);
    }
}
